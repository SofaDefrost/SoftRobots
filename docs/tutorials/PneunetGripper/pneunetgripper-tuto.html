<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <link rel="stylesheet" href="../../../docs/style.css" type="text/css" />
</head>
<body>
<h1 id="simulation">Simulation</h1>
<p>The simulation is done using the SOFA Open Source Framework and the &quot;Soft-Robots&quot; Plugin dedicated for Real-time simulation of Soft Robots. To define the simulation, a Python scene file is created and fed as input to SOFA. In the following, we will describe, step by step, the creation of scene file that perfom the simulation of the soft Pneunet gripper. A SOFA scene is an ordered tree of nodes (ex: <code>finger.</code>), with parent/child relationship (set up by <code>node.createChild()</code>). Each node has one or a few components (set up with <code>node.createObject()</code>). Every node and component has a name and a few features. The main node at the top of the tree is called &quot;rootNode&quot;.</p>
<h2 id="volumetric-meshing-and-loading">Volumetric Meshing and Loading</h2>
<p>To be able to simulate the soft robot, the first step is to discretise the soft robot in space, by creating a volumetric mesh, typically with tetrahedra. This can be done with any meshing tool such as Gmsh or CGAL. In this example, we use Gmsh. This will generate a vtk file containing all the information about postion of the nodes and connectivity between them through the tetrahedra.</p>
<p><a href="data/images/PneuNets-gripper_mesh.png">Meshed finger</a></p>
<p>In a SOFA scene the mesh is loaded using the loader component:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;MeshVTKLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCutCoarse.vtk&#39;</span>)</code></pre></div>
<p>This mesh is then stored in a <code>Mesh</code> component (linked to the loader through its <code>src</code> attribute), and a MechanicalObject component is created to store the degrees of freedom of the robot (which are the positions of all the nodes in the mesh)</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
finger.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;tetras&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, rx<span class="op">=</span><span class="st">&#39;0&#39;</span>, dz<span class="op">=</span><span class="st">&#39;0&#39;</span>)</code></pre></div>
<p><a href="details/step1-meshLoading.pyscn">Step1</a> ## Constitutive law of the material and Mass</p>
<h3 id="main-body">Main Body</h3>
<p>Next, we need to define what kind of material we are going to simulate, and this is done by adding a ForceField component, which describes what internal forces are created when the object is deformed. In particular, this will define how soft or stiff the material is, if it has an elastic or more complex behaviour (Hyperelastic, plastic, etc...). In this example, we use the TetrehedronFEMForceField component which corresponds to an elastic material deformation but with large rotations. Attributes such as Young's Modulus and Poisson's ratio can be set within this component:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="st">&#39;500&#39;</span>)</code></pre></div>
<p>The vertexMass of the material can be defined with the UniformMass component, which assumes a uniform distribution of the vertexMass inside the body:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;UniformMass&#39;</span>, totalMass<span class="op">=</span><span class="st">&#39;0.0008&#39;</span>)</code></pre></div>
<p>Note that by default, the gravity is defined as &quot;0 -9.81 0&quot;. You can redefine it with the following command in the rootNode:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rootNode.findData(<span class="st">&#39;gravity&#39;</span>).value<span class="op">=</span><span class="st">&#39;-9810 0 0&#39;</span><span class="op">;</span></code></pre></div>
<p>This corresponds to a gravity defined along the x axis, assuming the length unit is millimeters.</p>
<p><a href="details/step2-forceFieldAndMass.pyscn">Step2</a></p>
<h3 id="stiff-layer">Stiff layer</h3>
<p>To define the constitutive law of the stiff layer, we will create a new node and define a new ForceField with stiffer parameters only on the points which constitute the layer. To easily define the indices of the points which will be selected, we use the boxROI component wich allows to define a box that will contain all the points of the layer (refered by the node &quot;<code>modelSubTopo</code>&quot;). The box component contains successively the extreme coordinates along x, y and z</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;BoxROI&#39;</span>, name<span class="op">=</span><span class="st">&#39;boxROISubTopo&#39;</span>, box<span class="op">=</span><span class="st">&#39;-100 22.5 -8 -19 28 8&#39;</span>)
modelSubTopo <span class="op">=</span> finger.createChild(<span class="st">&#39;modelSubTopo&#39;</span>)
modelSubTopo.createObject(<span class="st">&#39;Mesh&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, tetrahedra<span class="op">=</span><span class="st">&quot;@boxROISubTopo.tetrahedraInROI&quot;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
modelSubTopo.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="st">&#39;1500&#39;</span>)</code></pre></div>
<p><a href="details/step3-stiffLayer.pyscn">Step3</a></p>
<h2 id="boundary-conditions">Boundary Conditions</h2>
<p>To fix the finger in space, it is necessary to define boundary conditions on some parts of the object. This can be done in several ways in SOFA. In this case, we use the component RestShapeSpringsForceField, which creates springs between the current position of a part of the body and its initial position. The stiffness of these springs can be adjusted. In particular, setting a very large stiffness will be equivalent to fixing the points in space. To easily define the indices of the points which will be fixed, we use the boxROI component:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;BoxROI&#39;</span>, name<span class="op">=</span><span class="st">&#39;boxROI&#39;</span>, box<span class="op">=</span><span class="st">&#39;-10 0 -20 0 30 20&#39;</span>)
finger.createObject(<span class="st">&#39;RestShapeSpringsForceField&#39;</span>, points<span class="op">=</span><span class="st">&#39;@boxROI.indices&#39;</span>, stiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>, angularStiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>)</code></pre></div>
<p><a href="details/step4-boundaryConditions.pyscn">Step4</a></p>
<h2 id="implicit-time-integration-and-matrix-solver">Implicit Time Integration and Matrix Solver</h2>
<p>Now that all the minimal elements of the scene have been described, it is already possible to simulate the deformation of the finger. To do that, we need to define a time integration scheme, which will define the system to be solved at each time step of the simulation, as well as a matrix solver, to solve that system and compute the updated velocities and positions of the nodes of the robot. In this case, we choose to use an Implicit Euler Scheme and a sparse direct Solver base on an LDL matrix decomposition:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>)
finger.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;directSolver&#39;</span>)</code></pre></div>
<p>With the scene in this state, not much will happen in the simulation, merely a small deformation due to gravity on the finger. Indeed, we did not include the pneumatic actuator yet.</p>
<p><a href="details/step5-timeIntegrationAndMatrixSolver.pyscn">Step5</a></p>
<h2 id="pneumatic-actuator-and-python-script-controller">Pneumatic Actuator and Python script controller</h2>
<p>In this section, we will introduce a pneumatic actuator that will allow to interactively simulate the inflation of the finger's cavity. To do that, we first create a node that will take care of this task. Then, the surface mesh of the cavity has to be loaded using a mesh loader and the position are stored in a Mesh component which is a container. A MechanicalObject is created to store the degrees of freedom of the cavity which will be deforming during the simulation. The actuator is created with the component SurfacePressureConstraint which is directly associated to the mesh container through the attribute &quot;triangles&quot;. The actuation can be defined either by pressure or volume growth. Finally, a BarycentricMapping component is created to map the deformation of the cavity mesh to the mesh of the finger:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">cavity <span class="op">=</span> finger.createChild(<span class="st">&#39;cavity&#39;</span>)
cavity.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCavityCut.stl&#39;</span>)
cavity.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;cavityMesh&#39;</span>)
cavity.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;cavity&#39;</span>)
cavity.createObject(<span class="st">&#39;SurfacePressureConstraint&#39;</span>, name<span class="op">=</span><span class="st">&quot;SurfacePressureConstraint&quot;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, value<span class="op">=</span><span class="st">&quot;0.0001&quot;</span>, triangles<span class="op">=</span><span class="st">&#39;@topo.triangles&#39;</span>, valueType<span class="op">=</span><span class="st">&quot;pressure&quot;</span>)
cavity.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>, name<span class="op">=</span><span class="st">&#39;mapping&#39;</span>)</code></pre></div>
<p>To interactively inflate the cavity, we use a PythonScriptController, which is a component referring to a python file performing some actions at the initialisation or during the simulation:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rootNode.createObject(<span class="st">&#39;PythonScriptController&#39;</span>, filename<span class="op">=</span><span class="st">&quot;controllerGripper.py&quot;</span>, classname<span class="op">=</span><span class="st">&quot;controller&quot;</span>)</code></pre></div>
<p>In this case, the controller allows to interactively inflate the cavity by pressing ctrl + '+' and deflate it by pressing ctrl + '-'.</p>
<h2 id="solving-the-constraints">Solving the constraints</h2>
<p>To solve the constraints, such as the one define by the pressure actuator, we have to add to the rootNode the component FreeMotionAnimationLoop that will build up the system including constraints. The component GenericConstraintSolver will also be added to solve the constraints problem. Finally, we add the component LinearConstraintCorrection to the finger Node to take into account the correction due to the cavity constraint to the velocity and position:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">rootNode.createObject(<span class="st">&#39;FreeMotionAnimationLoop&#39;</span>)
rootNode.createObject(<span class="st">&#39;GenericConstraintSolver&#39;</span>, maxIterations<span class="op">=</span><span class="st">&quot;10000&quot;</span>, tolerance<span class="op">=</span><span class="st">&quot;1e-3&quot;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">finger.createObject(<span class="st">&#39;LinearSolverConstraintCorrection&#39;</span>, solverName<span class="op">=</span><span class="st">&#39;directSolver&#39;</span>)</code></pre></div>
<p>With all these components, the scene is now runable and can be used to inflate and deflate the finger.</p>
<p><a href="data/images/PneuNets-gripper_OneFingerBendingAll.png">Real images</a></p>
<p><a href="details/step6-pneumaticActuatorAndPythonScriptController.pyscn">Step6</a></p>
<h2 id="creating-the-gripper">Creating the gripper</h2>
<h3 id="add-fingers">Add fingers</h3>
<p>Now, to create an actual gripper, we just need to create two more fingers and define their positions. To do that, you can use the same mesh files and use the 'translation' and 'rotation' attributes in the mesh loaders. Check the scene file in the appendix for more details.</p>
<h3 id="add-an-object-to-grab-and-a-plane-to-put-it-on">Add an object to grab and a plane to put it on</h3>
<p>In this scene, we create the object to grab and define it as rigid. This implies creating a new node, adding a time integration and a solver component, defining a vertexMass, and defining constraint corrections that will be used later for collisons.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">cube <span class="op">=</span> rootNode.createChild(<span class="st">&#39;cube&#39;</span>)
cube.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>)
cube.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;linearSolver&#39;</span>)
cube.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, template<span class="op">=</span><span class="st">&quot;Rigid&quot;</span>, scale<span class="op">=</span><span class="st">&quot;4&quot;</span>, position<span class="op">=</span><span class="st">&#39;-23 16 0 0 0 0 1&#39;</span>)
cube.createObject(<span class="st">&#39;UniformMass&#39;</span>, vertexMass<span class="op">=</span><span class="st">&#39;0.0008  74088  0.2352 0 0  0 0.2352 0  0 0 0.2352&#39;</span>)                cube.createObject(<span class="st">&#39;UncoupledConstraintCorrection&#39;</span>)</code></pre></div>
<p>We also need to define a plane, using the predefined meshes of SOFA:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">planeNode <span class="op">=</span> rootNode.createChild(<span class="st">&#39;Plane&#39;</span>)
planeNode.createObject(<span class="st">&#39;MeshObjLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&quot;mesh/floorFlat.obj&quot;</span>, triangulate<span class="op">=</span><span class="st">&quot;true&quot;</span>, rotation<span class="op">=</span><span class="st">&quot;0 0 270&quot;</span>, scale <span class="op">=</span><span class="dv">10</span>, translation<span class="op">=</span><span class="st">&quot;-122 0 0&quot;</span>)
planeNode.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)
planeNode.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)</code></pre></div>
<p>In this case, the file &quot;floorFlat.obj&quot; is defined in a shared directory of SOFA that is accessible in any SOFA scene.</p>
<h3 id="add-collisions">Add collisions</h3>
<p>As it stands, objects would go through each other as if they were ghosts. It is therefore necessary to handle collisions. This is simply done in SOFA by adding a collision model. In the case of 3-dimensional objects described with triangles and tetrahedra, this is typically done by adding the components 'Triangle', 'Line' and 'Point', that define the elements on the surface of the objects.</p>
<h4 id="plane">Plane</h4>
<p>The case of the plane is the most straignthforward: it is described by a surface and the components of collision can be directly added to its node, specifying it is not moving during the simulation:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">planeNode.createObject(<span class="st">&#39;Triangle&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)
planeNode.createObject(<span class="st">&#39;Line&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)
planeNode.createObject(<span class="st">&#39;Point&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)</code></pre></div>
<h4 id="object-to-grab">Object to grab</h4>
<p>For the object to grab, we said it as going to be rigid, but we did not define its shape yet. This is needed to define a collision model. Hence, we create a child node that will load this shape (predefined mesh available in SOFA), which we choose to be a cube and we add the collision model. It is also necessary to add a rigid mapping which will map the degrees of freedom of the cube mesh to a rigid SOFA component.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">cubeCollis <span class="op">=</span> cube.createChild(<span class="st">&#39;cubeCollis&#39;</span>)
cubeCollis.createObject(<span class="st">&#39;MeshObjLoader&#39;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;mesh/smCube27.obj&quot;</span>, triangulate<span class="op">=</span><span class="st">&quot;true&quot;</span>,  scale<span class="op">=</span><span class="st">&quot;6&quot;</span>)
cubeCollis.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)
cubeCollis.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, translation<span class="op">=</span><span class="st">&#39;0 0 0&#39;</span>)
cubeCollis.createObject(<span class="st">&#39;Triangle&#39;</span>)
cubeCollis.createObject(<span class="st">&#39;Line&#39;</span>)
cubeCollis.createObject(<span class="st">&#39;Point&#39;</span>)
cubeCollis.createObject(<span class="st">&#39;RigidMapping&#39;</span>)</code></pre></div>
<h4 id="fingers">Fingers</h4>
<p>The procedure is similar with the fingers: in a child node, we load a mesh representing the surface of the fingers and apply the collision model on it. Note that the nodes of this surface mesh need not match the ones of the associated volumetric mesh. Indeed, a barycentric mapping is used to map those collision degrees of freedom to the volumetric mesh ones:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">collisionFinger <span class="op">=</span> finger.createChild(<span class="st">&#39;collisionFinger&#39;</span>)
collisionFinger.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span>path<span class="op">+</span><span class="st">&#39;pneunetCut.stl&#39;</span>, translation <span class="op">=</span> translateFinger)
collisionFinger.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
collisionFinger.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;collisMech&#39;</span>)
collisionFinger.createObject(<span class="st">&#39;Triangle&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
collisionFinger.createObject(<span class="st">&#39;Line&#39;</span>,selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
collisionFinger.createObject(<span class="st">&#39;Point&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
collisionFinger.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)</code></pre></div>
<h2 id="thats-it-you-can-now-run-the-simulation-and-try-to-grab-the-cube">That's it, you can now run the simulation and try to grab the cube!</h2>
<p>In this case, the controller allows to inflate all the cavities by pressing ctrl + '+' and deflate them by pressing ctrl + '-'. The gripper can be moved up, down, left and right by pressing respectively ctrl + Up, Down, Left, Right. It can be turned clockwise and anticlockwise by pressing ctrl + 'a' and ctrl + 'q'.</p>
<p><a href="details/step7-grabTheCube.pyscn">Step7</a> If you want to play around, you can add components OglModel for every object to have a visual representation that suits you.</p>
<div class="figure">
<img src="data/images/PneuNets-gripper_inAction.png" alt="Real images" />
<p class="caption">Real images</p>
</div>
<h2 id="appendix">Appendix</h2>
<p>Here is the final SOFA scene simulation of the soft pneunet Gripper</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">import</span> Sofa
<span class="im">import</span> math
<span class="im">import</span> os

youngModulusFingers <span class="op">=</span> <span class="dv">500</span>
youngModulusStiffLayerFingers <span class="op">=</span> <span class="dv">1500</span>
poissonRatioFingers <span class="op">=</span> <span class="fl">0.3</span>
fingersMass <span class="op">=</span> <span class="fl">0.04</span>

radius <span class="op">=</span> <span class="dv">70</span>
angle1 <span class="op">=</span> <span class="dv">120</span><span class="op">*</span>math.pi<span class="op">/</span><span class="dv">180</span>  <span class="co"># Angle between 1st and 2nd finger in radian</span>
angle2 <span class="op">=</span> <span class="dv">240</span><span class="op">*</span>math.pi<span class="op">/</span><span class="dv">180</span>  <span class="co"># Angle between 1st and 3rd finger in radian</span>
translateFinger1 <span class="op">=</span> <span class="st">&quot;0 0 0&quot;</span>
translateFinger2 <span class="op">=</span> <span class="st">&quot;0 &quot;</span> <span class="op">+</span> <span class="bu">str</span>(radius <span class="op">+</span> radius<span class="op">*</span>math.sin(angle1<span class="op">-</span>math.pi<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> <span class="bu">str</span>(radius<span class="op">*</span>math.cos(angle1<span class="op">-</span>math.pi<span class="op">/</span><span class="dv">2</span>))
translateFinger3 <span class="op">=</span> <span class="st">&quot;0 &quot;</span> <span class="op">+</span> <span class="bu">str</span>(radius <span class="op">+</span> radius<span class="op">*</span>math.sin(angle2<span class="op">-</span>math.pi<span class="op">/</span><span class="dv">2</span>)) <span class="op">+</span> <span class="st">&quot; &quot;</span> <span class="op">+</span> <span class="bu">str</span>(radius<span class="op">*</span>math.cos(angle2<span class="op">-</span>math.pi<span class="op">/</span><span class="dv">2</span>))

<span class="kw">def</span> createScene(rootNode):

                rootNode.createObject(<span class="st">&#39;RequiredPlugin&#39;</span>, pluginName<span class="op">=</span><span class="st">&#39;SoftRobots&#39;</span>)
                rootNode.createObject(<span class="st">&#39;VisualStyle&#39;</span>, displayFlags<span class="op">=</span><span class="st">&#39;showVisualModels hideBehaviorModels hideCollisionModels hideBoundingCollisionModels hideForceFields showInteractionForceFields hideWireframe&#39;</span>)
                rootNode.findData(<span class="st">&#39;gravity&#39;</span>).value<span class="op">=</span><span class="st">&#39;-9810 0 0&#39;</span><span class="op">;</span>
                rootNode.createObject(<span class="st">&#39;FreeMotionAnimationLoop&#39;</span>)
                rootNode.createObject(<span class="st">&#39;GenericConstraintSolver&#39;</span>, tolerance<span class="op">=</span><span class="st">&quot;1e-12&quot;</span>, maxIterations<span class="op">=</span><span class="st">&quot;10000&quot;</span>)
                rootNode.createObject(<span class="st">&#39;CollisionPipeline&#39;</span>, verbose<span class="op">=</span><span class="st">&quot;0&quot;</span>)
                rootNode.createObject(<span class="st">&#39;BruteForceDetection&#39;</span>, name<span class="op">=</span><span class="st">&quot;N2&quot;</span>)
                rootNode.createObject(<span class="st">&#39;CollisionResponse&#39;</span>, response<span class="op">=</span><span class="st">&quot;FrictionContact&quot;</span>, responseParams<span class="op">=</span><span class="st">&quot;mu=0.7&quot;</span>)
                rootNode.createObject(<span class="st">&#39;LocalMinDistance&#39;</span>, name<span class="op">=</span><span class="st">&quot;Proximity&quot;</span>, alarmDistance<span class="op">=</span><span class="st">&quot;5&quot;</span>, contactDistance<span class="op">=</span><span class="st">&quot;1&quot;</span>, angleCone<span class="op">=</span><span class="st">&quot;0.01&quot;</span>)

        rootNode.createObject(<span class="st">&#39;BackgroundSetting&#39;</span>, color<span class="op">=</span><span class="st">&#39;0 0.168627 0.211765&#39;</span>)
                rootNode.createObject(<span class="st">&#39;OglSceneFrame&#39;</span>, style<span class="op">=</span><span class="st">&quot;Arrows&quot;</span>, alignment<span class="op">=</span><span class="st">&quot;TopRight&quot;</span>)
                rootNode.createObject(<span class="st">&#39;PythonScriptController&#39;</span>, filename<span class="op">=</span><span class="st">&quot;pythonControllers/wholeGripperController.py&quot;</span>, classname<span class="op">=</span><span class="st">&quot;controller&quot;</span>)

                planeNode <span class="op">=</span> rootNode.createChild(<span class="st">&#39;Plane&#39;</span>)
                planeNode.createObject(<span class="st">&#39;MeshObjLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/floorFlat.obj&quot;</span>, triangulate<span class="op">=</span><span class="st">&quot;true&quot;</span>, rotation<span class="op">=</span><span class="st">&quot;0 0 270&quot;</span>, scale <span class="op">=</span><span class="dv">10</span>, translation<span class="op">=</span><span class="st">&quot;-122 0 0&quot;</span>)
                planeNode.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)
                planeNode.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)
                planeNode.createObject(<span class="st">&#39;Triangle&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)
                planeNode.createObject(<span class="st">&#39;Line&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)
                planeNode.createObject(<span class="st">&#39;Point&#39;</span>, simulated<span class="op">=</span><span class="st">&quot;0&quot;</span>, moving<span class="op">=</span><span class="st">&quot;0&quot;</span>)
                planeNode.createObject(<span class="st">&#39;OglModel&#39;</span>,name<span class="op">=</span><span class="st">&quot;Visual&quot;</span>, fileMesh<span class="op">=</span><span class="st">&quot;data/mesh/floorFlat.obj&quot;</span>, color<span class="op">=</span><span class="st">&quot;1 0 0 1&quot;</span>,rotation<span class="op">=</span><span class="st">&quot;0 0 270&quot;</span>, scale <span class="op">=</span><span class="dv">10</span>, translation<span class="op">=</span><span class="st">&quot;-122 0 0&quot;</span>)

                cube <span class="op">=</span> rootNode.createChild(<span class="st">&#39;cube&#39;</span>)
                cube.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>)
                cube.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;linearSolver&#39;</span>)
                cube.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, template<span class="op">=</span><span class="st">&quot;Rigid&quot;</span>, scale<span class="op">=</span><span class="st">&quot;4&quot;</span>, position<span class="op">=</span><span class="st">&#39;-23 16 0 0 0 0 1&#39;</span>)<span class="co">#, dx=&quot;47.0&quot;, dy=&quot;10&quot;, dz=&quot;8&quot;, rx=&quot;10&quot; ,ry=&quot;10&quot;)</span>
                <span class="co">#cube.createObject(&#39;UniformMass&#39;, vertexMass=&#39;0.0008  74088  0.2352 0 0  0 0.2352 0  0 0 0.2352&#39;)</span>
                cube.createObject(<span class="st">&#39;UniformMass&#39;</span>, vertexMass<span class="op">=</span><span class="st">&#39;0.0008&#39;</span>)
                cube.createObject(<span class="st">&#39;UncoupledConstraintCorrection&#39;</span>)
                
                <span class="co">#collision</span>
                cubeCollis <span class="op">=</span> cube.createChild(<span class="st">&#39;cubeCollis&#39;</span>)
                cubeCollis.createObject(<span class="st">&#39;MeshObjLoader&#39;</span>, name<span class="op">=</span><span class="st">&quot;loader&quot;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/smCube27.obj&quot;</span>, triangulate<span class="op">=</span><span class="st">&quot;true&quot;</span>,  scale<span class="op">=</span><span class="st">&quot;6&quot;</span>)
                cubeCollis.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&quot;@loader&quot;</span>)
                cubeCollis.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, translation<span class="op">=</span><span class="st">&#39;0 0 0&#39;</span>)
                cubeCollis.createObject(<span class="st">&#39;Triangle&#39;</span>)
                cubeCollis.createObject(<span class="st">&#39;Line&#39;</span>)
                cubeCollis.createObject(<span class="st">&#39;Point&#39;</span>)
                cubeCollis.createObject(<span class="st">&#39;RigidMapping&#39;</span>)
                
                <span class="co">#visualization</span>
                cubeVisu <span class="op">=</span> cube.createChild(<span class="st">&#39;cubeVisu&#39;</span>)
                cubeVisu.createObject(<span class="st">&#39;OglModel&#39;</span>, name<span class="op">=</span><span class="st">&quot;Visual&quot;</span>, fileMesh<span class="op">=</span><span class="st">&quot;data/mesh/smCube27.obj&quot;</span>, color<span class="op">=</span><span class="st">&quot;0.0 0.1 0.5&quot;</span>, scale<span class="op">=</span><span class="st">&quot;6.2&quot;</span>)
                cubeVisu.createObject(<span class="st">&#39;RigidMapping&#39;</span>)



    <span class="co">##########################################</span>
        <span class="co"># Finger 1 Model                         #</span>
        <span class="co">##########################################</span>
                finger1 <span class="op">=</span> rootNode.createChild(<span class="st">&#39;finger1&#39;</span>)
                finger1.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>, rayleighStiffness<span class="op">=</span><span class="st">&#39;0.1&#39;</span>, rayleighMass<span class="op">=</span><span class="st">&#39;0.1&#39;</span>)
                finger1.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)
                
                finger1.createObject(<span class="st">&#39;MeshVTKLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCutCoarse.vtk&#39;</span>,translation <span class="op">=</span> translateFinger1)
                finger1.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                finger1.createObject(<span class="st">&#39;TetrahedronSetTopologyModifier&#39;</span>)
                finger1.createObject(<span class="st">&#39;TetrahedronSetTopologyAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                finger1.createObject(<span class="st">&#39;TetrahedronSetGeometryAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                
                finger1.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;tetras&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, showIndices<span class="op">=</span><span class="st">&#39;false&#39;</span>, showIndicesScale<span class="op">=</span><span class="st">&#39;4e-5&#39;</span>, rx<span class="op">=</span><span class="st">&#39;0&#39;</span>, dz<span class="op">=</span><span class="st">&#39;0&#39;</span>)
                finger1.createObject(<span class="st">&#39;UniformMass&#39;</span>, totalMass<span class="op">=</span><span class="bu">str</span>(fingersMass))
                finger1.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusFingers), drawAsEdges<span class="op">=</span><span class="st">&quot;1&quot;</span>)
          
                finger1.createObject(<span class="st">&#39;BoxROI&#39;</span>, name<span class="op">=</span><span class="st">&#39;boxROI&#39;</span>, box<span class="op">=</span><span class="st">&#39;-10 0 -20 0 30 20&#39;</span>, drawBoxes<span class="op">=</span><span class="st">&#39;true&#39;</span>,doUpdate<span class="op">=</span><span class="st">&#39;0&#39;</span>)
                <span class="co">#finger1.createObject(&#39;BoxROI&#39;, name=&#39;boxROI&#39;, box=&#39;-50 0 -20 0 30 20&#39;, drawBoxes=&#39;true&#39;,doUpdate=&#39;0&#39;)</span>
        finger1.createObject(<span class="st">&#39;BoxROI&#39;</span>, name<span class="op">=</span><span class="st">&#39;boxROISubTopo&#39;</span>, box<span class="op">=</span><span class="st">&#39;-100 22.5 -8 -19 28 8&#39;</span>, drawBoxes<span class="op">=</span><span class="st">&#39;false&#39;</span>)
                finger1.createObject(<span class="st">&#39;RestShapeSpringsForceField&#39;</span>, points<span class="op">=</span><span class="st">&#39;@boxROI.indices&#39;</span>, stiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>, angularStiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>)
                
                finger1.createObject(<span class="st">&#39;LinearSolverConstraintCorrection&#39;</span>, solverName<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)

                <span class="co">##########################################</span>
                <span class="co"># Sub topology                           #</span>
                <span class="co">##########################################</span>
                modelSubTopo <span class="op">=</span> finger1.createChild(<span class="st">&#39;modelSubTopo&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, tetrahedra<span class="op">=</span><span class="st">&quot;@boxROISubTopo.tetrahedraInROI&quot;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusStiffLayerFingers<span class="op">-</span>youngModulusFingers))


                <span class="co">##########################################</span>
                <span class="co"># Constraint                             #</span>
                <span class="co">##########################################</span>
                cavity <span class="op">=</span> finger1.createChild(<span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCavityCut.stl&#39;</span>,translation <span class="op">=</span> translateFinger1)
                cavity.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                cavity.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;SurfacePressureConstraint&#39;</span>, name<span class="op">=</span><span class="st">&quot;SurfacePressureConstraint&quot;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, value<span class="op">=</span><span class="st">&quot;0.0001&quot;</span>, triangles<span class="op">=</span><span class="st">&#39;@topo.triangles&#39;</span>, visualization<span class="op">=</span><span class="st">&#39;0&#39;</span>, showVisuScale<span class="op">=</span><span class="st">&#39;0.0002&#39;</span>, valueType<span class="op">=</span><span class="st">&quot;pressure&quot;</span>)
                cavity.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>, name<span class="op">=</span><span class="st">&#39;mapping&#39;</span>,  mapForces<span class="op">=</span><span class="st">&#39;false&#39;</span>, mapMasses<span class="op">=</span><span class="st">&#39;false&#39;</span>)                
                
                <span class="co">##########################################</span>
                <span class="co"># Collision                              #</span>
                <span class="co">##########################################</span>

                collisionFinger <span class="op">=</span> finger1.createChild(<span class="st">&#39;collisionFinger&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCut.stl&#39;</span>, translation <span class="op">=</span> translateFinger1)
                collisionFinger.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;collisMech&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;Triangle&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Line&#39;</span>,selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Point&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)


                <span class="co">##########################################</span>
                <span class="co"># Visualization                          #</span>
                <span class="co">##########################################</span>
                modelVisu <span class="op">=</span> finger1.createChild(<span class="st">&#39;visu&#39;</span>)                
                modelVisu.createObject(<span class="st">&#39;OglModel&#39;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/pneunetCut.stl&quot;</span>, template<span class="op">=</span><span class="st">&#39;ExtVec3f&#39;</span>, color<span class="op">=</span><span class="st">&#39;0.7 0.7 0.7 0.6&#39;</span>,translation <span class="op">=</span> translateFinger1)
                modelVisu.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)

    <span class="co">##########################################</span>
        <span class="co"># Finger 2 Model                         #</span>
        <span class="co">##########################################</span>
                finger2 <span class="op">=</span> rootNode.createChild(<span class="st">&#39;finger2&#39;</span>)
                finger2.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>, rayleighStiffness<span class="op">=</span><span class="st">&#39;0.1&#39;</span>, rayleighMass<span class="op">=</span><span class="st">&#39;0.1&#39;</span>)
                finger2.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)
                
                finger2.createObject(<span class="st">&#39;MeshVTKLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCutCoarse.vtk&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle1<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger2)
                finger2.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                finger2.createObject(<span class="st">&#39;TetrahedronSetTopologyModifier&#39;</span>)
                finger2.createObject(<span class="st">&#39;TetrahedronSetTopologyAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                finger2.createObject(<span class="st">&#39;TetrahedronSetGeometryAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                
                finger2.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;tetras&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, showIndices<span class="op">=</span><span class="st">&#39;false&#39;</span>, showIndicesScale<span class="op">=</span><span class="st">&#39;4e-5&#39;</span>, rx<span class="op">=</span><span class="st">&#39;0&#39;</span>, dz<span class="op">=</span><span class="st">&#39;0&#39;</span>)
                finger2.createObject(<span class="st">&#39;UniformMass&#39;</span>, totalMass<span class="op">=</span><span class="bu">str</span>(fingersMass))
                finger2.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusFingers), drawAsEdges<span class="op">=</span><span class="st">&quot;1&quot;</span>)
                finger2.createObject(<span class="st">&#39;RestShapeSpringsForceField&#39;</span>, points<span class="op">=</span><span class="st">&#39;@../finger1/boxROI.indices&#39;</span>, stiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>, angularStiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>)
                
                finger2.createObject(<span class="st">&#39;LinearSolverConstraintCorrection&#39;</span>, solverName<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)

                <span class="co">##########################################</span>
                <span class="co"># Sub topology                           #</span>
                <span class="co">##########################################</span>
                modelSubTopo <span class="op">=</span> finger2.createChild(<span class="st">&#39;modelSubTopo&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, tetrahedra<span class="op">=</span><span class="st">&quot;@../../finger1/boxROISubTopo.tetrahedraInROI&quot;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusStiffLayerFingers<span class="op">-</span>youngModulusFingers))


                <span class="co">##########################################</span>
                <span class="co"># Constraint                             #</span>
                <span class="co">##########################################</span>
                cavity <span class="op">=</span> finger2.createChild(<span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCavityCut.stl&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle1<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span> , translation<span class="op">=</span>translateFinger2)
                cavity.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                cavity.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;SurfacePressureConstraint&#39;</span>, name<span class="op">=</span><span class="st">&quot;SurfacePressureConstraint&quot;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, value<span class="op">=</span><span class="st">&quot;0.0001&quot;</span>, triangles<span class="op">=</span><span class="st">&#39;@topo.triangles&#39;</span>, visualization<span class="op">=</span><span class="st">&#39;0&#39;</span>, showVisuScale<span class="op">=</span><span class="st">&#39;0.0002&#39;</span>, valueType<span class="op">=</span><span class="st">&quot;pressure&quot;</span>)
                cavity.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>, name<span class="op">=</span><span class="st">&#39;mapping&#39;</span>,  mapForces<span class="op">=</span><span class="st">&#39;false&#39;</span>, mapMasses<span class="op">=</span><span class="st">&#39;false&#39;</span>)                
                
                <span class="co">##########################################</span>
                <span class="co"># Collision                              #</span>
                <span class="co">##########################################</span>

                collisionFinger <span class="op">=</span> finger2.createChild(<span class="st">&#39;collisionFinger&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCut.stl&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle1<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger2)
                collisionFinger.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;collisMech&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;Triangle&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Line&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Point&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)


                <span class="co">##########################################</span>
                <span class="co"># Visualization                          #</span>
                <span class="co">##########################################</span>
                modelVisu <span class="op">=</span> finger2.createChild(<span class="st">&#39;visu&#39;</span>)                
                modelVisu.createObject(<span class="st">&#39;OglModel&#39;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/pneunetCut.stl&quot;</span>, template<span class="op">=</span><span class="st">&#39;ExtVec3f&#39;</span>, color<span class="op">=</span><span class="st">&#39;0.7 0.7 0.7 0.6&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle1<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger2)
                modelVisu.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)

                <span class="co">##########################################</span>
                <span class="co"># Finger 3 Model                         #</span>
                <span class="co">##########################################</span>
                finger3 <span class="op">=</span> rootNode.createChild(<span class="st">&#39;finger3&#39;</span>)
                finger3.createObject(<span class="st">&#39;EulerImplicit&#39;</span>, name<span class="op">=</span><span class="st">&#39;odesolver&#39;</span>, rayleighStiffness<span class="op">=</span><span class="st">&#39;0.1&#39;</span>, rayleighMass<span class="op">=</span><span class="st">&#39;0.1&#39;</span>)
                finger3.createObject(<span class="st">&#39;SparseLDLSolver&#39;</span>, name<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)
                
                finger3.createObject(<span class="st">&#39;MeshVTKLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCutCoarse.vtk&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle2<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger3)
                finger3.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                finger3.createObject(<span class="st">&#39;TetrahedronSetTopologyModifier&#39;</span>)
                finger3.createObject(<span class="st">&#39;TetrahedronSetTopologyAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                finger3.createObject(<span class="st">&#39;TetrahedronSetGeometryAlgorithms&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>)
                
                finger3.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;tetras&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, showIndices<span class="op">=</span><span class="st">&#39;false&#39;</span>, showIndicesScale<span class="op">=</span><span class="st">&#39;4e-5&#39;</span>, rx<span class="op">=</span><span class="st">&#39;0&#39;</span>, dz<span class="op">=</span><span class="st">&#39;0&#39;</span>)
                finger3.createObject(<span class="st">&#39;UniformMass&#39;</span>, totalMass<span class="op">=</span><span class="bu">str</span>(fingersMass))
                finger3.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusFingers), drawAsEdges<span class="op">=</span><span class="st">&quot;1&quot;</span>)
                finger3.createObject(<span class="st">&#39;RestShapeSpringsForceField&#39;</span>, points<span class="op">=</span><span class="st">&#39;@../finger1/boxROI.indices&#39;</span>, stiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>, angularStiffness<span class="op">=</span><span class="st">&#39;1e12&#39;</span>)
                
                finger3.createObject(<span class="st">&#39;LinearSolverConstraintCorrection&#39;</span>, solverName<span class="op">=</span><span class="st">&#39;preconditioner&#39;</span>)

                <span class="co">##########################################</span>
                <span class="co"># Sub topology                           #</span>
                <span class="co">##########################################</span>
                modelSubTopo <span class="op">=</span> finger3.createChild(<span class="st">&#39;modelSubTopo&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronSetTopologyContainer&#39;</span>, position<span class="op">=</span><span class="st">&#39;@loader.position&#39;</span>, tetrahedra<span class="op">=</span><span class="st">&quot;@../../finger1/boxROISubTopo.tetrahedraInROI&quot;</span>, name<span class="op">=</span><span class="st">&#39;container&#39;</span>)
                modelSubTopo.createObject(<span class="st">&#39;TetrahedronFEMForceField&#39;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, name<span class="op">=</span><span class="st">&#39;FEM&#39;</span>, method<span class="op">=</span><span class="st">&#39;large&#39;</span>, poissonRatio<span class="op">=</span><span class="st">&#39;0.3&#39;</span>,  youngModulus<span class="op">=</span><span class="bu">str</span>(youngModulusStiffLayerFingers<span class="op">-</span>youngModulusFingers))


                <span class="co">##########################################</span>
                <span class="co"># Constraint                             #</span>
                <span class="co">##########################################</span>
                cavity <span class="op">=</span> finger3.createChild(<span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCavityCut.stl&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle2<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger3)
                cavity.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                cavity.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;cavity&#39;</span>)
                cavity.createObject(<span class="st">&#39;SurfacePressureConstraint&#39;</span>, name<span class="op">=</span><span class="st">&quot;SurfacePressureConstraint&quot;</span>, template<span class="op">=</span><span class="st">&#39;Vec3d&#39;</span>, value<span class="op">=</span><span class="st">&quot;0.0001&quot;</span>, triangles<span class="op">=</span><span class="st">&#39;@topo.triangles&#39;</span>, visualization<span class="op">=</span><span class="st">&#39;0&#39;</span>, showVisuScale<span class="op">=</span><span class="st">&#39;0.0002&#39;</span>, valueType<span class="op">=</span><span class="st">&quot;pressure&quot;</span>)
                cavity.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>, name<span class="op">=</span><span class="st">&#39;mapping&#39;</span>,  mapForces<span class="op">=</span><span class="st">&#39;false&#39;</span>, mapMasses<span class="op">=</span><span class="st">&#39;false&#39;</span>)                

                <span class="co">##########################################</span>
                <span class="co"># Collision                              #</span>
                <span class="co">##########################################</span>

                collisionFinger <span class="op">=</span> finger3.createChild(<span class="st">&#39;collisionFinger&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MeshSTLLoader&#39;</span>, name<span class="op">=</span><span class="st">&#39;loader&#39;</span>, filename<span class="op">=</span><span class="st">&#39;data/mesh/pneunetCut.stl&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle2<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger3)
                collisionFinger.createObject(<span class="st">&#39;Mesh&#39;</span>, src<span class="op">=</span><span class="st">&#39;@loader&#39;</span>, name<span class="op">=</span><span class="st">&#39;topo&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;MechanicalObject&#39;</span>, name<span class="op">=</span><span class="st">&#39;collisMech&#39;</span>)
                collisionFinger.createObject(<span class="st">&#39;Triangle&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Line&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;Point&#39;</span>, selfCollision<span class="op">=</span><span class="st">&quot;false&quot;</span>)
                collisionFinger.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)


                <span class="co">##########################################</span>
                <span class="co"># Visualization                          #</span>
                <span class="co">##########################################</span>
                modelVisu <span class="op">=</span> finger3.createChild(<span class="st">&#39;visu&#39;</span>)                
                modelVisu.createObject(<span class="st">&#39;OglModel&#39;</span>, filename<span class="op">=</span><span class="st">&quot;data/mesh/pneunetCut.stl&quot;</span>, template<span class="op">=</span><span class="st">&#39;ExtVec3f&#39;</span>, color<span class="op">=</span><span class="st">&#39;0.7 0.7 0.7 0.6&#39;</span>,rotation<span class="op">=</span><span class="bu">str</span>(<span class="dv">360</span> <span class="op">-</span> angle2<span class="op">*</span><span class="dv">180</span><span class="op">/</span>math.pi)<span class="op">+</span> <span class="st">&quot; 0 0&quot;</span>, translation<span class="op">=</span>translateFinger3)
                modelVisu.createObject(<span class="st">&#39;BarycentricMapping&#39;</span>)

                <span class="cf">return</span> rootNode</code></pre></div>
</body>
</html>
